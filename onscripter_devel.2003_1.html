<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML lang="ja">
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=EUC-JP">
<META http-equiv="Content-Style-Type" content="text/css">
<META name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
<TITLE> ONScripter 開発日誌 </TITLE>
<LINK rel="stylesheet" type="text/css" href="/ogapee.css">
</HEAD>

<body>

<div id="body">

<div id="header">
<H1>ONScripter 開発日誌</H1>

Since: Feb. 6, 2002<br>
Last updated: Mar. 23, 2003
</div> <!-- header -->

<div id="toc-container">

<h3>過去の開発日誌</h3>

<div id="toc">

<ul>
  <li> 2002年
    <ul>
      <li> <A HREF="onscripter_devel.2002_4.html">10月〜12月</A>
      <li> <A HREF="onscripter_devel.2002_3.html"> 7月〜 9月</A>
      <li> <A HREF="onscripter_devel.2002_2.html"> 4月〜 6月</A>
      <li> <A HREF="onscripter_devel.2002_1.html"> 1月〜 3月</A>
    </ul>
  <li> 2001年
    <ul>
      <li> <A HREF="onscripter_devel.2001.html">12月</A>
    </ul>
</ul>
</div> <!-- toc -->
</div> <!-- toc-container -->


<div id="diary-container">
<div id="diary">

<h2>2003年1月〜3月</h2>

<div class="diary-day">
<h3>3月23日</h3>

<P>αβεさんの patch を取り入れ、 arc でアーカイブファイルが見つからなくても処理を継続するように修正しました。</P>

<P>αβεさんの patch を取り入れ、reset で一時的にテキストが残ってしまうことがある不具合を修正しました。</P>

<P>αβεさんの patch を参考に、menusetwindow で背景色が省略されている場合（デフォルト値: #999999）の対応を追加しました。</P>

<P>αβεさんの patch を取り入れ、Ctrl キーでのスキップ機能を追加しました。</P>

<P>αβεさんの patch を取り入れ、Shift+'Q'で強制的に end を実行するように拡張しました。これは前から入れたかったのですが、簡単に押せるキーだと間違って押してしまう可能性があり、どうしようかと思っていたところでした。</P>

<P>そ〜かむさんの patch を参考に、MacOS X での MIDI 演奏に対応しました。現在の SDL on MacOSX では MIDI が演奏できないため、別途そ〜かむさんに作成していただいた ONScripter ランチャのMIDI再生補助機能に対応するための修正を行いました。これは SDL での不具合が解消されるまでの暫定的な処置になります。この ONScripter ランチャを含んだバイナリについては、<A HREF="http://homepage.mac.com/anmira/onscripter/">ONScripter for MacOS X</A>（かつらさん）からダウンロードできるようになる予定です。</P>

<h4>20030323a</h4>

<P>そ〜かむさんの patch に関連して、私が誤った修正をしてしまった箇所を直しました。</P>

</div>

<div class="diary-day">
<h3>3月16日</h3>

<P>効果番号15番が正常に描画されなくなっていたバグを修正しました。</P>

<P>alpha blending を書き直し高速化しました。</P>

<P>文字のクリッピングに関するバグを修正しました。</P>

<P>PDA および blt 用の画像の解像度変更ルーチンを、3x3 平滑化フィルタ＋ bi-linear 補間に変更しました。さらに、コンバータとルーチンを共通化しました。これでかなり綺麗に縮むようになりました。PDA でアーカイブを圧縮している人は、今回のコンバータで圧縮し直すことをお勧めします。ただし、補間をしている関係上、アルファ付き画像の縁が線として見えたり、特定色で抜いているカーソル画像の特定色境界が見えたりしますが、これはトレードオフなので我慢してください。デスクトップマシンでも、-DPDA 付きでコンパイルすることで、効果を試すことができます。</P>

</div>

<div class="diary-day">
<h3>3月6日</h3>

<P>s1100089さんからのバグ報告をもとに、goto の引数が文字列変数（$で始まる）の場合、正しく扱えていなかったバグを修正しました。parser を変更したときにエンバグしたようです。</P>

</div>

<div class="diary-day">
<h3>3月2日</h3>

<P>s1100089さんからのバグ報告をもとに、行のそれ以前に2byte文字（テキスト）が無い状態で@が現れたときに改行していたバグを取りました。</P>

</div>

<div class="diary-day">
<h3>3月1日</h3>

<P>だいぶ遅くなりましたが、beroさんに報告していただいたバグを修正しました。また、<A HREF="http://sdl-dc.sourceforge.net/onscripter-dc.html">ONScripter for Dreamcast</A>へのリンクを追加しました。</P>

</div>

<div class="diary-day">
<h3>2月22日</h3>

<P>beroさんにDreamcastでの動作報告をいただきました。同時に報告していただいたバグについては、近日中に修正したものをリリースいたします。</P>

</div>

<div class="diary-day">
<h3>2月10日</h3>

<P>かつをのえぼしさんに、ONScripter の<A HREF="http://tokyo.cool.ne.jp/eboshi/onscripter.html">Windows バイナリ</A>を公開していただきました。本来 Windows 上では製品付属のNScripterを使用すればよいのですが、ONScripter とNScripterとではセーブファイルに互換性が無いため、例えば外では PDA（SLシリーズのザウルス）、家では 
Windows でやりたいという方にはお勧めです。</P>

</div>


<div class="diary-day">
<h3>2月8日</h3>

<P>ADPCM の wave ファイルを bgm, mp3 で演奏できるように修正しました。</P>

<P>soundpressplgin, spi に暫定対応しました。指定された拡張子を NBZ 復号するようにします。そもそも、spi や soundpressplgin によるデコード処理はアーカイブ側でやるべきではないのですが、ONScripter ではどのみち DLL を使用できないため、NBZ を仮定して便宜上アーカイブ側で復号するようにしています。</P>

<P>命令後の@や\の取り扱いや、#（色指定）のみの行の取り扱いの不具合を修正しました。</P>

<P>試しにとった<A HREF="http://galileo.spaceports.com/~ogapee/onscripter.html">http://galileo.spaceports.com/~ogapee/onscripter.html</A>が、なぜかαβεさんに補足されています。しかし、ここはさしあたり更新しません。現行のスペースが使えなくなった場合にバックアップとして使用します。</P>

</div>


<div class="diary-day">
<h3>2月6日</h3>

<P>ページ公開から一周年です。</P>

<P>かつらさんに <A HREF="http://homepage.mac.com/anmira/onscripter/">ONScripter for MacOS X</A> を公開していただきました。Mac OS X ユーザの方でONScripterのコンパイルに苦労されている方は是非お試し下さい。</P>

</div>

<div class="diary-day">
<h3>2月4日<span style="color:red">20030128〜20030202 を使っている人は、要差し換え。セーブファイルが壊れています。</span></h3>

<P>かつらさんからのバグ報告を元に、20030128以降でセーブファイルが正常に作成されない不具合を修正しました。たいへん申し訳ありませんが、20030128 および 20030202 で作成したセーブファイルは破棄して下さい。</P>

<P>遠藤さんからのバグ報告を元に、puttext 後の改行に関する不具合を修正しました。</P>

<P>αβεさんの patch を取り入れ、getreg の不具合を修正しました。</P>

<P>mask 指定の不具合を修正しました。</P>

<P>アーカイブ圧縮時に、左上もしくは右上のピクセルを透過色に指定している画像の場合に、補間の影響によって透過色が正しく反映されない場合があったため、補間方法を従来の bi-linear に戻しました。</P>

</div>


<div class="diary-day">
<h3>2月2日</h3>

<P>nsaconv, sarconv の画像解像度変更ルーチンにおいて、メモリを正しく確保していないバグを修正しました。</P>

<P>A.Bさんからの報告を元に、(条件ファイル名)"TRUE文字列""FALSE文字列"の解釈におけるバグを修正しました。</P>

</div>


<div class="diary-day">
<h3>1月28日</h3>

<P>αβεさんの patch を参考に、lsp で mask や string 指定を解釈する際のバグを取りました。プログラムが終了してしまう重大なバグなので、20030126 を使っている人は必ず更新してください。</P>

</div>


<div class="diary-day">
<h3>1月26日</h3>

<P>αβεさんの patch を取り入れ、ファイル直接読み込み(DirectReader)時に ファイルが見付からなければ、ファイル名を大小文字区別せずに検索して読み込むよう修正しました。(Win32 以外) (注: ディレクトリ名を区別しないようにはなってません。 その辺にも対応するとしたら、 もっとまともな実装方法にする必要があります)</P>

<P>αβεさんの patch を参考に、ファイル直接読み込み(DirectReader)時にファイルが無圧縮の場合のファイルサイズを正しく扱えていなかったバグを修正しました。</P>

<P>αβεさんの patch を参考に、nsa で arc.nsa が見付からない場合に続行するように修正しました。</P>

<P>αβεさんの patch を取り入れ、reset 時に font の色を reset しないように修正しました。</P>

<P>αβεさんの patch を参考に、readToken で、現状態がテキストではない場合、'\'や'@'を区切りとして解釈するように変更しました。goto 等で指定ラベルの後に '\' 等の ゴミがあった場合に対する修正です。</P>

<P>数字の式（ mov %0,1+(2*%4+(5-3 mod 2)) など）に対応しました。parser にかなり大掛かりな変更を加えました。エンバグしている可能性があります。</P>

<P>以下は内部関数の説明です。</p>
<ul>
<li> readStr() 命令文引数の文字列・色、もしくはテキスト途中の文字列変数を読む
<li> readInf() 命令文引数の数字、もしくはテキスト途中の数字変数を読む
<li> readToken() 命令文自体、ラベル、テキスト文章およびその他を読む
</ul>

<P>nsaconv を圧縮後 640x480 モードに対応しました。-e オプションを組み合わせることにより、640x480→640x480 もしくは 800x600→640x480 の変換でよく縮みます。</P>

<P>-e 付き 640x480 にしてギリギリ512MBのCFに収まるゲームをやってみました。swap を 64MB とって、なんとか正常に動きました。ただし、無視できますが、メモリー不足というウィンドウが頻繁に出ます。free で見ると、used が瞬間最大風速 Mem: 29604, Swap: 57684, Total 87288 までいきます。このゲームは特に同時使用画像量が多いと思うのですが、一般にVGA だとデータ量も半端ではないので、使われていない画像データを一時的に解放する機構を実装しないときついかもしれません。画面は非常に綺麗です。</P>

<P>640x480→640x480 の場合は、onscripter-cf, onscripter-sdのアイコンを使ってください。800x600→640x480の場合は、対応するアイコンを作ってないので、コンソールから以下のように実行してください。そのうちに launcher を作ります。</P>

<pre>
onscripter --root /mnt/cf/nscr --force-button-shortcut --disable-rescale 
</pre>

<P><A HREF="http://free.prohosting.com/">free.prohosting.com</A>は一回限りだという支払いをしないとアカウントを抹消される可能性が濃厚なので、<A HREF="http://www.tripod.co.jp/">tripod.co.jp</A>に移転しました。</P>

</div>

<div class="diary-day">
<h3>1月21日</h3>

<P>藤田さんが ONScripter の Free BSD Ports を公開してくださったので、リンクを張りました。</P>
</div>

<div class="diary-day">
<h3>1月6日</h3>

<P>sarconv, nsaconv の解像度変更を、2x2近傍バイリニア補間から4x4近傍重み付きバイリニア補間に変更しました。少しはきれいになったでしょうか？</P>
</div>

<div class="diary-day">
<h3>1月2日</h3>

<P>Zaurus で入力を受け付けなくなる現象ですが、Frame Buffer Driver のロックに関するSDL on Qtopiaの不具合が原因でした。SL-C700以外ではこの不具合はでないようなので、VGAとQVGAの切り替えに関する部分と干渉していたのだと思います。</P>

<P>以下は探求の軌跡です。</P>

<ol>
<li>まず、マルチスレッド関連で dead lock になっていることを疑いました。ところが、アプリケーション内のQt 関連の部分は single thread で動いており、これは入力を受け付けなくなっても動いているため、アプリケーション内部では dead lock していないようです。つまり、ONScripterLabel::eventLoop の中で以下のループ自体は正常に回っていますが、Key event や Mouse event が QApplication に来なくなっているようです。

<PRE>
ONScripterLabel::eventLoop{
  SDL_WaitEvent  
    SDL_PumpEvents
      qApp-&gt;processEvents
        qt_fbdpy-&gt;getEvent （Frame Buffer Driverからイベントを受け取る）
          qwsProcessEvent （widgetへイベント発行）
            widget-&gt;###event（widgetのイベント処理）
              SDL_Private####（SDL のイベントをキューへ）
        select　（時間制限つきイベント待ち）
          widget-&gt;event（widgetへイベント発行）
            widget-&gt;###event（widgetのイベント処理）
              SDL_Private####（SDL のイベントをキューへ）
    SDL_PeepEvents（SDL イベントキューからイベントを取り出す）
  ONScripter でのSDLイベントの処理
}
</PRE>

<li>次に、某ゲームで入力を受け付けなくなる確率９５％以上（１００％ではないところがいやらしい……）の場所で、スクリプトとONScripterの双方を少しずつ修正していき問題を切り分けました。すると、どうやら ONScripterLabel::flush() を多発すると入力を受け付けなくなる確率が高くなるということが判明しました。画面表示を全く行わないと、入力を受け付けなくなることはありません。<br>

ONScripterLabel::flush を呼び出すと、以下の関数が順に呼び出されて SDL_QWin::repaintRect で Frame Buffer に直接描画されます。つまり、この時の Frame Buffer アクセスが何か悪いことを引き起こしているようです。

<pre>
ONScripterLabel::flush()
  SDL_UpdateRect()
    QT_NormalUpdate()
      SDL_QWin::repaintRect(const QRect&amp; rect)
</pre>

<li>ここでは QDirectPainter で直接 Frame Buffer にアクセスしているのですが、Web で QDirectPainter の使用例を探したところ以下の例が見つかりました。

<OL>
  <LI>関数スコープ内でスタックに実体を生成しFrame Buffer Driver をロック
  <LI>Frame Buffer に操作
  <LI>スコープから抜けるときにデコンストラクタを呼ばせてロックを解除
</OL>

<li>ところが、SDL_QWin では以下のようにしています。<br>

<OL>
  <LI>new で確保
  <LI>Frame Buffer に操作
  <LI>QDirectPainter::end()（実際はQPainter::end()）を呼んだ後 delete で解放
</OL>

ここで試しに、end() を呼ばないようにしたところ、入力を受け付けなくなることはいっさい無くなりました。この end() は、QDirectPainter の親クラスである QPainter のデコンストラクタでも呼ばれる機会があり、それ以前に呼ばれていなければそこで呼び出されます。つまり、~ QDirectPainter() で終了処理をする前に、親クラスの end() で親クラスの終了処理をしているため、~QDirectPainter() の終了処理がうまくいっていなかったようです。

<li>また、公開されている qtopia-free-1.5.0 を自分でコンパイルし、libqte.so.2.3.2, libqpe.so.1.5.0 を作って、ONScripter をこれとリンクさせて走らせてみました。しかし、C700 ではプログラム自体は動くのですが、起動時に Protocol error 等の表示が出る上、そもそもアプリケーションがイベントをもらえないようでうまくいきません。というわけで、C700用のソースが公開されるまでは Qt/E のソースを直接いじることはできそうにありません。

</ol>

<P>文字列スプライトの描画で一文字ずつ flush していたのを、文字列全体で一回 flush するように変更しました。</P>

<P>いつのまにか SL-5500 で Home が効くようになっていてびっくりしました。</P>

</div>

</div> <!-- diary -->
</div> <!-- diary-container -->


<div id="footer">
Copyright (c) 1998-2006 Studio O.G.A. All rights reserved.
</div> <!-- footer -->

</div> <!-- body -->

</BODY>
</HTML>

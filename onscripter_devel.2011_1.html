<!DOCTYPE html>
<html lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <title>ONScripter 開発日誌</title>
  <link rel="stylesheet" type="text/css" href="/ogapee.css">
</head>

<body>
  <div id="body">

    <div id="header">
      <h1>ONScripter 開発日誌</h1>

      Since: Feb. 6, 2002<br>
      Last updated: Dec. 26, 2011
    </div> <!-- header -->

    <div id="toc-container">

      <h3>過去の開発日誌</h3>

      <div id="toc">
        <ul>
          <li><a href="onscripter_devel.2010_1.html">2010年</a></li>
          <li><a href="onscripter_devel.2009_1.html">2009年</a></li>
          <li><a href="onscripter_devel.2008_1.html">2008年</a></li>
          <li><a href="onscripter_devel.2007_1.html">2007年</a></li>
          <li><a href="onscripter_devel.2006_1.html">2006年</a></li>
          <li><a href="onscripter_devel.2005_1.html">2005年</a></li>
          <li><a href="onscripter_devel.2004_1.html">2004年</a></li>
          <li>2003年
            <ul>
              <li><a href="onscripter_devel.2003_4.html">10月～12月</a></li>
              <li><a href="onscripter_devel.2003_3.html"> 7月～ 9月</a></li>
              <li><a href="onscripter_devel.2003_2.html"> 4月～ 6月</a></li>
              <li><a href="onscripter_devel.2003_1.html"> 1月～ 3月</a></li>
            </ul>
          </li>
          <li>2002年
            <ul>
              <li><a href="onscripter_devel.2002_4.html">10月～12月</a></li>
              <li><a href="onscripter_devel.2002_3.html"> 7月～ 9月</a></li>
              <li><a href="onscripter_devel.2002_2.html"> 4月～ 6月</a></li>
              <li><a href="onscripter_devel.2002_1.html"> 1月～ 3月</a></li>
            </ul>
          </li>
          <li>2001年
            <ul>
              <li><a href="onscripter_devel.2001.html">12月</a></li>
            </ul>
          </li>
        </ul>
      </div> <!-- toc -->
    </div> <!-- toc-container -->


    <div id="diary-container">
      <div id="diary">

        <h2>2011年</h2>

        <div class="diary-day">
          <h3>12月26日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=222">解像度について</a>」を元に、スクリプト先頭の ;$ による設定を読み込む部分のバグを修正しました。</p>

          <p>strsph 命令を実装しました。</p>
        </div>

        <div class="diary-day">
          <h3>12月25日</h3>

          <p>スクリプト先頭の ;$ による設定に対応しました。これにより任意の解像度を設定できるようになったため、--wide オプションは廃止しました。</p>

          <p>Android 版でも任意の解像度を設定できます。Android 版の場合は、スクリプトで指定された任意の解像度が、アスペクト比を保ったままデバイスの実画面を最大限使って表示されるように ONScripter 側で自動的に拡大・縮小されます。ボタンは、もし余白（右側か下側）があればそこに表示されます。</p>
        </div>

        <div class="diary-day">
          <h3>12月22日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=221">Regression: English mode not working after 20111218</a>」を元に、20111218 に修正ミスがあり、ENABLE_1BYTE_CHAR を指定したときに、英語モードで表示がおかしくなるバグを修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>12月19日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=219">strsp・logsp2についてと要望</a>」を元に、20111218 に修正ミスがあり、主に文字列スプライトで、偶数番目に半角スペースが来てその直後に文字列が終了する場合に表示がおかしくなるバグが生じており、これを修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>12月18日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=219">strsp・logsp2についてと要望</a>」を元に、strsp, logsp, logsp2 命令の表示位置がずれるバグを修正しました。また、getcursorpos2, kinsoku 命令を実装しました。</p>

          <p>先頭が半角文字であっても、常に 2byte ずつ文字を描画するように変更しました。</p>
        </div>

        <div class="diary-day">
          <h3>12月17日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=215">saveoffのロード</a>」を元に、saveoff 命令を実行したときに実行状態をメモリに保存し、savegame 命令か右クリックメニューからの保存でそれをファイルに出力するようにしました。saveon の状態では、本来は全命令の先頭で実行状態を保存しなければいけないようですが、この場合実行速度がかなり遅くなってしまうのであえてやりません。今回ご報告いただいた場合を含め、たいていの場合には今回の修正で同じ挙動になると思います。もし不具合があればご連絡下さい。</p>
        </div>

        <div class="diary-day">
          <h3>11月10日</h3>

          <p>MP3 形式の音楽をループなしで再生し、フェードアウトを有効にして停止しようとするときに、フェードアウト中に音楽の最後まで到達すると処理が無限ループに陥ってしまうバグを修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>11月2日</h3>

          <p>Android 版において、ボタン表示の有無および画面の表示位置の情報を保存するようにしました。アプリを終了してから再び実行したときに設定が引き継がれます。</p>
        </div>

        <div class="diary-day">
          <h3>10月25日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=214">exbtn_dについて</a>」を元に、btnwait を実行した直後に exbtn_d の指定が反映されないことがあるバグを修正しました。</p>

          <p>エミュレータ上での確認ですが、Android 4.0 でも問題なく動作しています。</p>
        </div>

        <div class="diary-day">
          <h3>10月22日</h3>

          <p>フェードアウトを有効にした状態で Ogg Vorbis 形式の音楽を停止し、直後に音楽を再生したときに、新たに再生した音楽がすぐに停止してしまうことがあるバグを修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>10月12日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=213">「海洋レストラン☆海猫亭」動作中の操作にて</a>」を元に、trap 命令が stop の状態でクリックもしくはスペース・リターンキーが押されたときに、resume 後に指定されたラベルにジャンプされないバグを修正しました。</p>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=212">bgmfadein/fadeoutについて</a>」を元に、mp3fadeout, bgmfadeout でフェードアウト時間を変更したときに、現在フェードアウト中の音楽は影響を受けないようにしました。</p>
        </div>

        <div class="diary-day">
          <h3>10月11日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=212">bgmfadein/fadeoutについて</a>」を元に、Ogg Vorbis 形式の音楽ファイルを再生するときのフェードイン・フェードアウトは、フェード開始後終了を待たずに次の命令に進むようにしました。本家では、Ogg Vorbis 形式の場合は終了を待たず、MP3 形式の場合は終了を待つようになっているため、これにならいました。20111010 では MP3 形式でしかチェックしていなかったため、常に終了を待つようになっていました。</p>
        </div>

        <div class="diary-day">
          <h3>10月10日</h3>

          <p>[Backport] <a href="http://unclemion.com/onscripter/">ONScripter-EN</a>を参考に mp3fadein, mp3fadeout, bgmfadein, bgmfadeout を実装しました。</p>
        </div>

        <div class="diary-day">
          <h3>10月9日</h3>

          <p>文字列スプライトで、ルビが有効な時にルビ一行分小さく画像を確保していたバグを修正しました。</p>

          <p>automode 実行時に画面効果が瞬間表示になってしまうバグを修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>10月8日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=193">ムーンライトバスケットが動かない</a>」と「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=209">「ムーンライトバスケット」操作不可</a>」に関連して、新画像ボタン用の bclear, bcursor, bdef, bdown, bexec, bsp, btime, btrans を実装しました。</p>
        </div>

        <div class="diary-day">
          <h3>10月7日</h3>

          <p>追加機能要望「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=204">ns2アーカイブへの対応</a>」に関連して、ns2 アーカイブの読み込みルーチンのバグを修正しました。また、もし ns2 アーカイブが存在する場合は必ず読み込むようにしました。</p>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=210">「海洋レストラン☆海猫亭」動作不可</a>」を元に、文字列スプライトの指定が正しく解釈されない場合があったため修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>9月27日</h3>

          <p>BTS で突然以下のようなエラーが表示されるようになりました。</p>

          <pre>
Following errors occurred. Please contact administrator.

undefined method `to_time' for #&lt;DateTime: 10604607289/4320,0,2299161&gt;
(NoMethodError)
</pre>

          <p style="text-indent:0"><a href="http://www.daifukuya.com/kagemai/guest.rbx?action=view_report&amp;id=370&amp;project=kagemai">影舞の BTS</a>によると、dbi が新しいと発生するようです。以下のパッチが置いてあったので適用したところ解決しました。おそらく sourceforge.jp 側でプログラムが更新されたことが原因だと思います。</p>

          <pre>
--- dbistore3.rb	(リビジョン 603)
+++ dbistore3.rb	(作業コピー)
@@ -26,6 +26,12 @@
 require 'kagemai/searchcond'
 require 'kagemai/dbiutil'
 
+class DateTime
+  def to_time
+    Time.local(year(), month(), day(), hour(), min(), sec())
+  end
+end
+
 module Kagemai  
   module BaseDBIStore3
</pre>
        </div>

        <div class="diary-day">
          <h3>9月25日</h3>

          <p>Uncle Mion さんより、大文字と小文字が区別されないファイルシステムでは ONScripter.cpp と onscripter.cpp が同時に存在できないというご指摘をいただいたので、onscripter.cpp を onscripter_main.cpp に変更しました。</p>

          <p>追加機能要望「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=208">IS01での動画再生</a>」を元に、Android 版において動画ファイルを再生する際に動画ファイルが存在するか調べ、存在しない場合には動画再生アプリを呼び出さないようにしました。</p>
        </div>

        <div class="diary-day">
          <h3>9月24日</h3>

          <p>クラス名を ONScripterLabel から ONScripter に変更(置換)しました。これに伴いファイル名も変更になっています。開発初期には<a href="http://qt.nokia.com/">Qt</a>(当時は trolltech 社の製品)の QLabel を継承して実装していたため名前を ONScripterLabel にしました。その後、音楽や画像のサポートが充実している<a href="http://www.libsdl.org">SDL</a>を代わりに使うようになりましたが、クラス名はついそのままにしていました。今になって変更することでご迷惑をおかけしてしまう方もいらっしゃるかと思いますが、以前から気になっていたことでもありこの際変更させていただきます。</p>

          <p>セーブファイルをロード中にクリックもしくはタップを連打すると、読み込み中にイベントキューがあふれてしまい、必要なイベントを追加できずにフリーズしてしまうことがありました。対症療法ですが、ロード後にキューにたまったイベントを消去するようにしました。</p>

          <p>HTC Desire の OS を 2.3.3 にアップデートしました。てっきり OTA で配布されるものと思っていましたが、<a href="http://htcdev.com/">HTCDev</a>の Kernel Source Code からプログラムをダウンロードして実行する必要がありました。2.2 と比べて ONScripter の動作が体感できるくらい速くなりました。</p>
        </div>

        <div class="diary-day">
          <h3>9月23日</h3>

          <p>セーブファイルの読み込み関数にバグがあり、まれにセグメンテーションフォルトを引き起こすことがありました。beta-20030811 でセーブファイルを本家と互換性のある形式に変更して以来ずっと残っていたバグでした。また、もはや必要ないと思うので bete-20030811 以前の独自セーブファイル形式のサポートを終了しました。</p>

          <p>セーブファイルには解像度変換前の座標関連値を保存していますが、セーブとロードを繰り返すと値が変化する場合があるバグを修正しました。</p>

          <p>yesnobox を解釈するようにしました。ただし、常にイエスであるとみなして変数に 1 をセットします。</p>

          <p>[Backport] 追加機能要望「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=204">ns2アーカイブへの対応</a>」を実現するため、<a href="http://unclemion.com/onscripter/">ONScripter-EN</a>を参考に ns2 アーカイブの読み込みに対応しました。</p>
        </div>

        <div class="diary-day">
          <h3>9月19日</h3>

          <p>btndown 1 の時に、マウスボタンを押した瞬間のみボタン押下処理をするのではなく、押したままマウスを動かした場合でも押下処理をするようにしました。本家では、マウスボタンを押した状態ではマウスを動かさなくともイベントが連続して発生し押下処理をするようですが、これへの対応は保留にします。これを使うと、ドラッグして画面をスクロールするインターフェースが作成できます。</p>

          <p>strsp でルビが表示されるようにしました。</p>
        </div>

        <div class="diary-day">
          <h3>9月18日</h3>

          <p>spbtn, exbtn の時点でボタン画像を可視化するのではなく、btnwait の時点で可視化するように修正しました。</p>

          <p>textgosub や pretextgosub 回りの挙動がおかしくなっていたので修正しました。</p>

          <p>Android 3.x で HOME ボタンを押すとそこからうまく復帰しなかったようなので、復帰時に onStop() を経由したかどうかを調べ、経由していない場合にのみサーフェスを再構成するように修正しました（下記）。実機の Android 2.2、およびエミュレータの Andorid 3.2 で試しましたが HOME を押しても電源ボタンを押しても正常に復帰します。エミュレータの Android 1.6 では、HOME からは復帰しますが、電源ボタンはそもそも押しても反応しないようなので実機でどうなるかは分かりません。</p>

          GLSurfaceView_SDL.java:<br>
          <pre>
    class GLThread extends Thread implements SwapBuffersCallback {
...
        public void onResume()
        {
            synchronized (this){
                mWidth = 0;
                mHeight = 0;
                mPaused = false;
                notify();
            }
            if (mStopped == false){ // e.g. resume from power button
                surfaceCreated();
                onWindowResize(mWidthBack, mHeightBack);
            }
        }
</pre>
        </div>

        <div class="diary-day">
          <h3>9月10日</h3>

          <p>textspeeddefault を実装しました。</p>

          <p>グラフィックファイル指定において、&quot;&gt;幅,高さ,#色&quot;で長方形を設定したときに、a(アルファブレンド)指定が正しく処理されないバグを修正しました。</p>

          <p>getcursorpos において、文字位置がテキストウィンドウの右端にあるときに、カーソル位置が次行の先頭に来ないでそのまま右にはみ出してしまうバグを修正しました。</p>

          <p>BTS で突然以下のようなエラーが出てページが表示されなくなりました。</p>

          <pre>
Following errors occurred. Please contact administrator.
undefined method `[]=' for nil:NilClass (NoMethodError)
</pre>

          <p style="text-indent:0">以下のように guest.cgi のデバッグ出力を有効にして実行すると、</p>

          <pre>
$DEBUG = 1
$SHOW_ENV_VARS = true # debug
$KAGEMAI_DEBUG = true # debug
</pre>

          <p style="text-indent:0">以下のような出力が出ました。</p>

          <pre>
kagemai/lib/kagemai/cache_manager.rb:69:in `save_cache'
/usr/lib/ruby/1.8/pstore.rb:322:in `transaction'
/usr/lib/ruby/1.8/pstore.rb:321:in `catch'
/usr/lib/ruby/1.8/pstore.rb:321:in `transaction'
kagemai/lib/kagemai/cache_manager.rb:68:in `save_cache'
kagemai/lib/kagemai/project.rb:431:in `save_cache'
kagemai/lib/kagemai/kagemai.rb:92:in `action'
cgi-bin/kagemai/guest.cgi:65:in `execute'
cgi-bin/kagemai/guest.cgi:113
</pre>

          <p style="text-indent:0">結局、以下のファイルを削除したら直りました。</p>

          <pre>
kagemai/project/onscripter/cache/cache.pstore
</pre>

          <p>allsphide で立ち絵も消すようにしました。</p>
        </div>

        <div class="diary-day">
          <h3>9月4日</h3>

          <p>mp3(bgm) 使用時に、ある種の WAVE ファイルは Mix_LoadMUS_RW() を使ったストリーミング再生に失敗するので、失敗したときには Mix_LoadWAV_RW() によって一度全部メモリ上に読み込んでから再生するようにしました。この場合再生されるまで若干待たされますが、再生されないよりはましだと思います。</p>

          <p>本家との互換性向上のため細かい個所を修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>8月30日</h3>

          <p>おそらくボタンの表示・非表示の切り替えに対応した頃から、手元の Android 2.2 では問題ありませんが、Android 1.6 だとゲームを選択した後に落ちてしまうようです。Emulator で実行すると、ログに以下の情報が残っていました。</p>

          <pre>
W/dalvikvm(  294): threadid=3: thread exiting with uncaught exception
E/AndroidRuntime(  294): Uncaught handler: thread main exiting due to uncaught exception
E/AndroidRuntime(  294): java.lang.RuntimeException: mBaselineAlignedChildIndex of LinearLayout set to an index that is out of bounds.
</pre>

          <p style="text-indent:0">調べたところ、Android 1.6 で LinearLayout を子要素なしで表示すると上の例外を出して落ちてしまうようです。そこで、ダミーの非表示ボタンを子要素として追加するようにしました。これで Android 1.6 でも遊べるようになったと思います。</p>

          <p>また、Android 版のバージョンが 20110828 となっていましたが、20110827 の間違いでした。今回の更新でファイル名は 20110827-1 になります。</p>
        </div>

        <div class="diary-day">
          <h3>8月28日</h3>

          <p>Android 版において、電源ボタンを押した後に正しく復帰するようにしました。１年前からの懸案がようやく解決しました。修正点は以下のとおりです。</p>

          <ol>
            <li>電源ボタンが押されると、通常は画面の向きが変更されるため、Activity を再構築するために onDestroy() が呼ばれますが、以下のようにしてこれを回避しました。<br>この方法は<a href="http://sonscripter.com">Sonscripter</a>の開発者の方に教えていただいたのですが、これで終了することは無くなったものの、復帰後に画面の描画が更新されなくなるという問題がありました。ちなみに、この状態から HOME ボタンで処理をバックグラウンドに移し、アイコンをタップして復帰すると正常に戻ります。<br>
              onscripter_android/AndroidManifest.xml:
              <pre>
android:configChanges=&quot;orientation|keyboardHidden&quot;
</pre>
            </li>

            <li>HOME ボタンを押して復帰すると、onPause() → onStop() → onStart() → onResume() が呼ばれ、その過程でサーフェスが破棄・生成されます。しかし、電源ボタンを押した場合は onPause() → onResume() が呼ばれるためサーフェスが古いままになっていました。そこで、onPause() と onResume() で GLSurfaceView_SDL のサーフェスを明示的に破棄・生成するようにしました。<br>
              こんなことをしてよいのか分かりませんが、手元では問題なく動いています。<br>
              onscripter_android/src/Video.java:
              <pre>
	@Override
	public void onPause() {
		nativeKey( 0, 3 ); // send SDL_ACTIVEEVENT
		super.onPause();
		surfaceDestroyed(this.getHolder());
	}

	@Override
	public void onResume() {
		nativeKey( 0, 3 ); // send SDL_ACTIVEEVENT
		super.onResume();
		surfaceCreated(this.getHolder());
		surfaceChanged(this.getHolder(), 0, mRenderer.mWidth, mRenderer.mHeight);
	}
</pre>
            </li>

            <li>wake lock を生成するときになぜか PowerManager.ON_AFTER_RELEASE を指定していたため、電源ボタンを押すと onPause() の直後に onRelease() が呼ばれていました。そのため、画面がオフにならず、また音楽も再生され続けていました。以下のように wake lock を作成することによって、電源ボタンを押すと画面がオフになりかつ音楽の音量が０になるようになりました。なお、もう一度電源ボタンを押すと正しくゲームに復帰します。<br>
              onscripter_android/src/ONScripter.java:
              <pre>
	wakeLock = pm.newWakeLock(PowerManager.SCREEN_DIM_WAKE_LOCK, "ONScripter");
</pre>
            </li>
          </ol>
        </div>

        <div class="diary-day">
          <h3>8月27日</h3>

          <p>Android 版において、起動した後に１回余計にビデオを再設定することがあり、その際に画面がちらつくことがある問題を修正しました。これに伴い ONScripter 本体も修正していますが、Android 以外のプラットホームには無関係の修正です。</p>

          <p>Android 版の専用アプリを作成する場合に、今まではゲームデータを初回にダウンロードする必要がありましたが、<a href="android/#customize">ゲームデータを内蔵したアプリ</a>も作成できるようにしました。assets フォルダにゲームの構成ファイルを配置してアプリを作成し、インストール後の初回起動時に SD カードにコピーします。</p>

          <p>ところで、Android 2.2 以前では、assets フォルダにある 1MB 以上のファイルを圧縮して apk に含める、プログラムから読み込む際に失敗してしまいます。これを回避するには、ant の設定ファイル (main_rules.xml) の中で &lt;nocompress /&gt; を有効にします。こうすると、assets フォルダ内のファイルを圧縮しないで apk が作成され、大きなファイルでも問題なく読み込んでコピーすることができるようになります。</p>
        </div>

        <div class="diary-day">
          <h3>8月25日</h3>

          <p>Android 版において、ボタンとメニューの日本語表示に対応しました。日本語環境では日本語に、その他の環境では英語表示になります。また、<a href="android/#button">ボタン</a>と<a href="android/#menu">メニュー</a>の内容を変更し、「上」「下」ボタンで前後の選択ボタンに移動できるようにしました。画面が小さくてボタンが押しづらい場合に利用してください。</p>
        </div>

        <div class="diary-day">
          <h3>8月20日</h3>

          <p>Windows での <a href="android/#develop">Android 版アプリの開発方法</a>の手順をまとめました。</p>

          <p>また、これまでは Linux で開発しておりその際はうまくいっていたのですが、今回 Windows でコンパイルに失敗する個所が見つかったため、SDK (onscripter_android.tar.gz) を修正しました。以下のように Android.mk でヘッダファイルを探索する場所を LOCAL_C_INCLUDES を使って指定しないといけないようです。</p>

          <pre>
LOCAL_C_INCLUDES := $(LOCAL_PATH)/include

LOCAL_CFLAGS := $(LOCAL_C_INCLUDES:%=-I%) \
	-DSDL_JAVA_PACKAGE_PATH=$(SDL_JAVA_PACKAGE_PATH) \
	-DSDL_CURDIR_PATH=\"$(SDL_CURDIR_PATH)\" \
	-DSDL_TRACKBALL_KEYUP_DELAY=$(SDL_TRACKBALL_KEYUP_DELAY)
</pre>
        </div>

        <div class="diary-day">
          <h3>8月19日</h3>

          <p>transbtn を実行して btnwait でボタンをクリックした際に、候補となるボタンが複数ある場合はその場所で最も透過度が低い（不透明な）ボタンを選択するようにしました。</p>

          <p>btntime で 0 を指定したときに、btnwait で待ち時間が 0 にならないバグを修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>8月17日</h3>

          <p>Android 版において、MENU ボタンを押すと<a href="android/#menu">メニュー</a>が出るようにしました。これに伴い、右クリックを MENU ボタンで代用する機能と BACK ボタンを押しながら MENU ボタンを押すと終了する機能は無くなりました。</p>
        </div>

        <div class="diary-day">
          <h3>8月16日</h3>

          <p>Android 版において、初回にダウンロードするゲームデータ(zip ファイル)の暗号化に対応しました。暗号方式は <a href="http://www.winzip.com/">WinZip</a> の 256-bit AES のみをサポートしています。パスワードはパッケージ(apk)に埋め込みます。暗号化手順については<a href="android/#customize">ゲームデータの初回ダウンロード機能</a>を参照してください。これで有料アプリケーションを開発しやすくなったと思います。</p>
        </div>

        <div class="diary-day">
          <h3>8月15日</h3>

          <p>画像を読み込む際のアルファ値の設定方法にバグがあり画像データが正しく読み込まれないことがあるバグを修正しました。</p>

          <p>getscreenshot の中で画像をリサイズせずに、savescreenshot の中でリサイズするようにしました。</p>

          <p>[Backport] <a href="http://unclemion.com/onscripter/">ONScripter-EN</a>を参考に automode_time のデフォルト値を 1000 に変更し、また automode_time の値を envdata に格納するようにしました。</p>

          <p>Android 版において、余白が大きい場合にソフトウェアボタンがなるべく正方形になるようにしました。</p>

          <h4>20110815a</h4>

          <p>ひしゃまるさんからのバグ報告を元に、スプライトの大きさが意図せず変更されてしまうことがあるバグを修正しました。</p>

          <p>ひしゃまるさんからのバグ報告を元に、グラフィックファイル指定において&quot;&gt;幅,高さ,#色&quot;で長方形を設定したときに、16bpp モードでは色が正しく設定されないバグを修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>8月13日</h3>

          <p>Android アプリケーションでは、外部記憶装置(SDカードなど)上の以下の場所にデータを保存するのが流儀のようです。</p>

          <pre>
/Android/data/&lt;package_name&gt;/
</pre>

          <p style="text-indent:0">
            これまでは、起動時にゲームを選択しない場合は strings.xml の game_directory でゲームの構成ファイルがある場所を指定していましたが、それをやめて上記の場所に置くように変更しました。また、端末の API Level が 8 以上(Android 2.2 以上)の場合は、ここにあるファイルはアプリケーションのアンインストール時に同時に消去されます。</p>

          <p>Android 版の<a href="android/#customize">ゲームデータの初回ダウンロード機能</a>を改善しました。</p>

          <ol>
            <li>zip 内のディレクトリが展開されないバグを修正しました。</li>
            <li>BufferedInputStream, BufferedOutputStream を介してファイルの読み書きをするようにしました。ディスクのアクセス速度が遅い場合でも、データを貯めて一度に読み書きするのでゲームデータの展開速度が多少速くなっていると思います。</li>
            <li>read/write の間に以下のウェイトを入れることによってプログレスバーの更新頻度を上げ、止まっているように見えることがないようにしました。
              <pre>
try{
    Thread.sleep(1);
} catch (InterruptedException e){
}
</pre>
            </li>
          </ol>

          <p> フォルダに .nomedia というファイルを置くと、そのフォルダより下の階層にある画像や音楽ファイルはギャラリーや音楽プレイヤーの検索対象外になるようです。</p>
        </div>

        <div class="diary-day">
          <h3>8月7日</h3>

          <p><a href="http://cutlass.qee.jp">cutlass さん</a>製作のゲーム<a href="https://market.android.com/details?id=jp.cutlass.noesis">NOeSIS 体験版</a>がアンドロイドマーケットで公開されました。<a href="android/">ONScripter on Android</a>をゲームエンジンに使っていただいています。今回、ダウンロード機能の追加などで協力させていただきました。おもしろいのでぜひ遊んでください。</p>
        </div>

        <div class="diary-day">
          <h3>8月6日</h3>

          <p>Android 版において、<a href="android/#customize">ゲームデータの初回ダウンロード機能</a>を改善しました。まず、</p>
          <pre>
HttpConnectionParams.setSoTimeout(client.getParams(), 3000);
</pre>
          <p style="text-indent:0">
            によってタイムアウトを設定し、タイムアウト後にサーバに再接続することによってダウンロード途中に止まりっぱなしになることを回避しました。また、再接続時に</p>
          <pre>
request.addHeader("Range", "bytes="+downloaded+"-"+totalLen);
</pre>
          <p style="text-indent:0">
            によって、（可能なら）タイムアウトした時点からダウンロードを再開するようにしました。また、上の変更に伴い、ダウンロードと展開を同時に行っていたのを、まず zip ファイルをダウンロードし、ダウンロード後に展開するように変更しました。</p>
        </div>

        <div class="diary-day">
          <h3>8月1日</h3>

          <p>Android 版において、<a href="android/#customize">ゲームデータの初回ダウンロード機能</a>を実装しました。この機能を使ってパッケージを作成し、ゲームの構成ファイルを単一の zip ファイルにまとめてウェブサーバ上に置いておくと、初回のみインターネット経由でダウンロードして端末に展開します。</p>
        </div>

        <div class="diary-day">
          <h3>6月19日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=201">お絵かき戦争で落ちる</a>」を元に、getcselstr で、定義されていない選択肢の文字列を取得しようとすると終了してしまうバグを修正しました。定義されていない場合は空文字列を設定するようにしました。</p>

          <p>１年前からの懸案ですが、Android 版を実行中に電源ボタンを押すと onPause() -&gt; onStop() -&gt; onDestroy() が呼ばれ、もう一度電源ボタンを押すと onCreate() -&gt; onStart() -&gt; onResume() が呼ばれてゲーム選択画面から再開してしまいます。一方、HOME ボタンを押すと onPause() -&gt; onStop() まで呼ばれ、バックグラウンドで実行を続けます。バックグラウンドから復帰をすると、onRestart() -&gt; onStart() -&gt; onResume() が呼ばれて続行します。電源ボタンを押したときも同じようにしたいのですが、どうしたらよいか分かりません。Winamp は電源ボタンを押しても再生し続けるので、技術的にはできそうですが…。</p>
        </div>

        <div class="diary-day">
          <h3>5月28日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=197">恋するトナカイで勝手にページ送りされる</a>」を元に、texthide 状態でも文字描画直後は文字が表示されるようにしました。根本的には、スクリプト側で texthide 状態のまま textshow をせず進行しているところに問題があり、そのため本家を使っても右クリックメニューから戻ると文章が復帰しません。また、この修正に伴い不必要な描画を削減しているので、全体的な描画速度も向上していると思います。もしかしたら、別の個所で表示がおかしくなっているかもしれないため、その場合はご報告下さい。</p>

          <p>Android 版をコンパイルしようとしたら、デバッグキーの有効期限が切れていました。Android 版の開発を始めてからちょうど１年が経過したことになります。~/.android/debug.keystore を削除して再コンパイルしたところ、自動的に新しいデバッグキーが作成されました。デバッグキーが変わったため、パッケージのアップデートはできません。古い ONScripter はいったんアンインストールしてから、新しい ONScripter をインストールしてください。</p>
        </div>

        <div class="diary-day">
          <h3>5月21日</h3>

          <p><a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=top">バグトラッキングシステム（影舞）</a>において、バグ報告を個別に XML ファイルで管理する方式から、MySQL で管理する方式に変更しました。個別に管理する方法では、sourceforge.jp の場合、検索条件にも依存しますが、バグ報告数がだいたい 140 を超えたあたりから、検索中にタイムアウトして internal server error になってしまうことが多くなります。「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?action=view_report&amp;id=193&amp;project=onscripter">ムーンライトバスケットが動かない</a>」で一度変更を試みましたが、途中で以下のようにエラーになってしまい断念していました。</p>

          <pre>
[]$ ruby bin/convert.rb onscripter Kagemai::MySQLStore3
/usr/lib/ruby/1.8/pstore.rb:354:in `load': undefined class/module Kagemai::ActionResult (ArgumentError)
        from /usr/lib/ruby/1.8/pstore.rb:354:in `load'
        from /usr/lib/ruby/1.8/pstore.rb:310:in `transaction'
        from lib/kagemai/cache_manager.rb:77:in `invalidate_cache'
        from lib/kagemai/project.rb:435:in `invalidate_cache'
        from lib/kagemai/project.rb:178:in `save_config'
        from bin/convert.rb:59:in `convert_store_type'
        from bin/convert.rb:73
</pre>

          <p>今回よく調べてみたところ、実は MySQL のデータベースの作成自体は正常に終了しており、その後のキャッシュの削除で失敗していることが分かりました。そこで、以下のように手動でキャッシュの削除と設定ファイルの変更をしたところ、問題なく移行できているようです。前回の検索数の制限も元に戻しました。これで、ＢＴＳの検索と統計が制限なく使えるようになっていると思います。</p>

          <pre>
[]$ rm project/onscripter/cache/*

[]$ vi project/onscripter/config
旧）
@db_manager_class = Kagemai::XMLFiles
新）
@db_manager_class = Kagemai::MySQLStore3
</pre>

          <p>ちなみに、データベースのバックアップと復元は以下のように行います。</p>

          <pre>
[]$ mysqldump -u onscripter -p -h mysql?.sourceforge.jp -B onscripter  | gzip &gt; mysql_onscripter.dump.gz

[]$ gunzip -c mysql_onscripter.dump.gz | mysql -u onscripter -p -h mysql?.sourceforge.jp
</pre>
        </div>

        <div class="diary-day">
          <h3>5月20日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=194">
              transbtnCommandの戻り値がない</a>」を元に、ONScripterLabel::transbtnCommand 関数で戻り値を設定していなかったバグを修正しました。</p>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=196">
              人工女神がボタン操作で落ちる</a>」を元に、prnum において、数値ラベル番号が0～99の範囲を超えている場合に、処理を中断（ゲームは続行）するようにしました。なお prnum は、本家のマニュアルを見ると ver 2.93 以降で非推奨になっています。</p>
        </div>

        <div class="diary-day">
          <h3>4月16日</h3>

          <p>要望が多いようなので、--wide オプションを指定することによりワイドスクリーンモードに対応するようにしました。ONScripter ではゲーム画面の比率は通常 4:3 に固定されていますが、ワイドスクリーンモードではこの比率が 16:9 になります。ゲーム画面の横幅は、スクリプトから 320, 400, 640, 800 のいずれかに指定できます(デフォルトは 640)。縦幅は上記の比率から決定されます。画像はゲーム画面に合わせて用意してください。</p>

          <p>Android 版では、起動時にワイドスクリーンモード(16:9)と通常表示(4:3)を選択できます。実際に表示する際には、デバイスの解像度に合うように ONScripter 側でゲーム画面を伸縮して表示します。</p>

          <p>コンパイル時に渡す PDA を廃止しました。デバイス画面の横幅を指定する場合は PDA_WIDTH を、デバイス画面の横幅を自動取得する場合は PDA_AUTOSIZE を指定してください。</p>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=190">
              レミュオールの錬金術師で落ちる</a>」を元に、SDL のイベントが立て続けに発生すると、キューに入った ONS_BREAK_EVENT が正しく処理されないバグを修正しました。</p>

          <p>ソースを少し修正し、Android 版バイナリも更新しました。ファイル名は同一です。</p>
        </div>

        <div class="diary-day">
          <h3>3月20日</h3>

          <p>たいていのゲームには無関係ですが、nsa アーカイブ内の nbz 形式のファイルを読み込む際に、復元後のサイズが正しく取得されずセグメンテーションフォルトを引き起こすことがあるバグを修正しました。</p>

          <p>今のところ VPlayer は快適です。ただし、独立した動画プレーヤーであるため、ONScripter の画面（左寄せ）からシームレスに動画画面（中央寄せ）に移行できない点が難点ですが。</p>

          <p>VPlayer Advanced という動画プレーヤー(VPlayer とは無関係)が出ていたので試してみましたが、ONScripter から使う場合には、同じ動画を再生しようとすると最初からではなく前回中断したところから再生される、画面がスクリーンいっぱいに拡大されるため HTC Desire では横に延びてしまう、といった不具合がありました。</p>
        </div>

        <div class="diary-day">
          <h3>3月11日</h3>

          <p>Android 版の外部動画プレーヤーとして RockPlayer Lite を使用していましたが、同じ動画を再生しようとすると最初からではなく前回中断したところから再生される、たまにプレーヤーが起動されないことがある、たまに ONScripter の onDestroy() が呼ばれ終了してしまうことがある、など色々不具合がありました。代わりに VPlayer を使ってみたところ、今のところ上記の問題は発生せず快適に使用できています。</p>

          <p>Android 版をコンパイルする時の<a href="android/#customize">カスタマイズ</a>について記載しました。</p>
        </div>

        <div class="diary-day">
          <h3>3月9日</h3>

          <p>Android 版において、外部プレーヤーを利用して動画を再生できるようにしました。native C++ の ONScripter からコールバックで ONScripter.java の以下の関数を呼びます。再生できる動画の形式は外部プレーヤーに依存します。外部プレーヤーは何でも構いませんが、当方では対応する形式が多い RockPlayer Lite を使用しています（推奨しているわけではありません）。動画再生中は onPause() が呼ばれるため ONScripter の実行は中断されます。動画再生終了後に onResume() が呼ばれて実行が再開されます。なお、今回のリリースは Android 以外のプラットフォームでは変更点はありません。</p>

          <pre>
public void playVideo(char[] filename){
    try{
        String filename2 = "file:/" + gCurrentDirectoryPath + "/" + new String(filename);
        filename2 = filename2.replace('\\', '/');
        Log.v("ONS", "playVideo: " + filename2);
        Uri uri = Uri.parse(filename2);
        Intent i = new Intent(Intent.ACTION_VIEW);
        i.setDataAndType(uri, "video/*");
        startActivityForResult(i, -1);
    }
    catch(Exception e){
        Log.e("ONS", "playVideo error:  " + e.getClass().getName());
    }
}
</pre>
        </div>

        <div class="diary-day">
          <h3>3月8日</h3>

          <p>Android 版において、Widget を使用して画面の右側（もしくは下側）に表示されるボタンを描画するようにしました。これまでは ONScripter 内で文字だけを使ってボタンを描画していたため、見た目がずいぶんよくなったと思います。ONScripter のソースの変更はありません。ボタン描画のコードは次回のリリースで削除します。</p>

          <p>Android 版で movie などから動画(MPEG-1)を再生できるようにしたいのですが、よい方法を思いつきません。SMPEG はコンパイルは簡単にできましたが、そのままでは画面がそもそも描画されず、また音声は再生されるものの遅延がひどくて実用になりません。MPEG-4 に変換することを前提に VideoView で再生しようとしましたが、GLSurfaceView.Renderer.onDrawFrame() -&gt; ONScripter (Native C++) -&gt; Handler -&gt; VideoView という経路では再生できませんでした。困りました。</p>
        </div>

        <div class="diary-day">
          <h3>2月26日<span style="color:red">重大なバグ修正</span></h3>

          <p>Android 版でゲームをしていたところ、以前から認識はしていたのですがあまりに頻繁に落ちるので、原因を探ってみました。__android_log_print() を使っていわゆる printf デバッグをした結果、ONScripterLabel::stopBGM() 内に Android 版に限らずセグメンテーションフォルトを引き起こす可能性のあるバグを見つけたため修正しました。音楽再生を開始するタイミングでよく落ちていた問題はこれが原因だと思います。修正後に某ゲームを最初から最後までスキップで流してみましたが一度も落ちませんでした。これでかなり安定したと思います。</p>
        </div>

        <div class="diary-day">
          <h3>2月23日</h3>

          <p>underline の値をセーブファイルに保存するようにしました。</p>

          <p>lsp2 系の命令において、X拡大率とY拡大率の積が負の場合に画像が表示されないバグを修正しました。</p>

          <p>transbtn を実装しました。transbtn 使用時にキーボードショートカットによってボタンの選択ができるように、マウスカーソルによるボタンの選択状態を判定する際に、ボタンの矩形領域の一番左上の１画素は常に可視であるとして処理しています。</p>
        </div>

        <div class="diary-day">
          <h3>1月29日</h3>

          <p>Android 版において、Home キーを押して処理をバックグラウンドに移したときに、音量が０になるようにしました。</p>
        </div>

        <div class="diary-day">
          <h3>1月11日</h3>

          <p>画像ファイルや音楽ファイルを読み込む際に new(std::nothrow) を使い、NULL が返ってきた場合には読み込みを中止して続行するようにしました。突然落ちることが少なくなるかもしれません。</p>

          <p>コードを整理しました。</p>
        </div>

        <div class="diary-day">
          <h3>1月10日</h3>

          <p>画面の描画に関して、更新する領域のバウンディングボックス全体を常に描画するように変更しました。これまでは、個々の更新領域の面積の総和がバウンディングボックスの面積よりも小さい場合には個別に更新していましたが、描画処理（フレームバッファへの画像転送）に時間がかかるプラットフォームではかえって遅くなっていました。</p>

          <p>入力待ちをクリックで飛ばしたときに、瞬間表示がテキスト終端で止まらないバグを修正しました。</p>

          <p>コードを整理しました。</p>
        </div>

        <div class="diary-day">
          <h3>1月8日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=186">
              rndについて</a>」を元に、Windows (Visual Studio 2008 C++) などにおいて、一回目の rnd の結果が毎回ほぼ同じ値になる問題を回避しました。乱数のシード値に time(NULL) を使っていますが、どうも上記のコンパイラで用意された rand() では、シード値が近い値の場合に最初の乱数値も近い値になってしまうようです。そのため、乱数の系列を初期化した直後の最初の乱数値を捨てるようにしました。</p>

          <p>[Backport] <a href="http://onscripter.unclemion.com/">ONScripter-EN</a>を参考に lsp2add, lsph2add, lsp2sub, lsph2sub を実装しました。</p>

          <p>!w, wait がクリックで飛ばせるようになっていたため修正しました。もしかしたら、他のクリック待ち判定に悪影響が出ているかもしれません。</p>
        </div>

        <div class="diary-day">
          <h3>1月7日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=182">
              画面のサイズについて</a>」に関連して、Android 版パッケージのゲーム選択
            画面上部に disable rescale の有無を指定するチェックボックスを配置しま
            した。チェックをすると、アーカイブ内の画像の大きさを画面に合わせて自動
            的に調整する機能が無効になります。</p>
        </div>

        <div class="diary-day">
          <h3>1月6日</h3>

          <p>バグ報告「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=180">
              Zaurus で透過 PNG の表示がおかしい。</a>」に関連して、Zaurus 版の関連
            ライブラリパッケージ(20110105)に Ogg Vorbis 形式の音楽ファイルが再生さ
            れない問題があったため修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>1月5日</h3>

          <p>アルファ値のない 24bit PNG を透過形式 a (アルファブレンド)で読み込む場合に、画像の右半分をマスク画像とするのではなく、本家と同じく画像全体を表示するようにしました。「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=175">onscripterでの画像表示</a>」や「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=180">Zaurus での透過 PNG の表示がおかしい。</a>」や「<a href="http://onscripter.sourceforge.jp/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=184">αブレンドのpng</a>」が関連するバグ報告です。</p>

          <p>Zaurus 版のライブラリパッケージ(20101229)の作成方法が間違っており、PNG 画像を読み込むことができなかったため、作り直しました。</p>
        </div>

      </div> <!-- diary -->
    </div> <!-- diary-container -->


    <div id="footer">
      Copyright (c) 1998-2011 Studio O.G.A. All rights reserved.
    </div>

  </div>
</body>

</html>
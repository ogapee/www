<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML lang="ja">

<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <META http-equiv="Content-Style-Type" content="text/css">
  <META name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <TITLE> ONScripter 開発日誌 </TITLE>
  <LINK rel="stylesheet" type="text/css" href="/ogapee.css">
</HEAD>

<body>

  <div id="body">

    <div id="header">
      <H1>ONScripter 開発日誌</H1>

      Since: Feb. 6, 2002<br>
      Last updated: Sep. 28, 2003
    </div> <!-- header -->

    <div id="toc-container">

      <h3>過去の開発日誌</h3>

      <div id="toc">

        <ul>
          <li> 2003年
            <ul>
              <li> <A HREF="onscripter_devel.2003_2.html"> 4月～ 6月</A>
              <li> <A HREF="onscripter_devel.2003_1.html"> 1月～ 3月</A>
            </ul>
          <li> 2002年
            <ul>
              <li> <A HREF="onscripter_devel.2002_4.html">10月～12月</A>
              <li> <A HREF="onscripter_devel.2002_3.html"> 7月～ 9月</A>
              <li> <A HREF="onscripter_devel.2002_2.html"> 4月～ 6月</A>
              <li> <A HREF="onscripter_devel.2002_1.html"> 1月～ 3月</A>
            </ul>
          <li> 2001年
            <ul>
              <li> <A HREF="onscripter_devel.2001.html">12月</A>
            </ul>
        </ul>
      </div> <!-- toc -->
    </div> <!-- toc-container -->


    <div id="diary-container">
      <div id="diary">

        <h2>2003年7月～9月</h2>

        <div class="diary-day">
          <h3>9月28日</h3>

          <P> ns3 を実装しました。nsaconv, nsadec にも -ns3 オプションを追加しました。</P>

          <P>exbtn の移動指定(M)において、移動前の場所を再描画していなかったバグを修正しました。</P>

          <P>解像度変換ルーチンの平滑化の幅を圧縮比によって可変にし、単純平均を取ることにしました。</P>

          <P> Ogg Vorbis を使用しない場合にコンパイルが通らないバグを修正しました。</P>

        </div>

        <div class="diary-day">
          <h3>9月2日</h3>

          <P><A HREF="http://www.tripod.co.jp/">tripod</A>と<A HREF="http://isweb.www.infoseek.co.jp/">isweb</A>とのサービス統合に伴い、メインページの URL が<A HREF="http://ogapee.at.infoseek.co.jp/onscripter.html">http://ogapee.at.infoseek.co.jp/onscripter.html</A>に変更になります。旧ページも１２月までは新ページにフォワードされるそうですが、リンクを張られている方は変更をお願いします。</P>

          <P> wave 系の命令における Ogg Vorbis 形式の演奏に対応しました。最初に全部デコードしてから演奏します。SDL_mixer でも Ogg Vorbis 形式に対応していますが、これだとよく BGM に使用される MP3 形式と同時に演奏できません。そのため、SDL_mixer を使わず自前でデコードし、wave 形式に変換してから SDL_mixer の channel に渡すようにしました。</P>

          <P> nsaconv, sarconv において、jpeg の再圧縮時に、元の画像が小さいと再圧縮に失敗することがある場合に対処しました。再圧縮後のサイズを知る方法が分からないので、0x400 bytes 余計にバッファを確保するようにしました。</P>

          <P> 整数演算しか使用しない Ogg Vorbis Codec <A HREF="http://xiph.org/ogg/vorbis/download/tremor_cvs_snapshot.tgz">tremor_cvs_snapshot.tgz</A> があったので、ザウルスではこちらを使用することにしました。ザウルス以外でも、これをインストールして Makefile を一部変更すればこちらを使用できます。また、onscripter-lib にこれを追加しました。</P>

          <P> savescreenshot, savescreenshot2 を実装しました。ただし、両者の違いが分からなかったため実装は同じです。なお、現在書出しは BMP フォーマットのみに対応しています。これに伴い、圧縮アーカイブを使い --disable-rescale を指定していても、ファイルがアーカイブ内に無い場合には、画像ファイルを読み込み時に解像度変換する仕様にしました。</P>

          <P>exbtn の移動指定(M)に対応しました。</P>

          <P>ザウルスパッケージで、VGA 表示で圧縮アーカイブを使う場合のアイコンを追加しました。詳しくは<A HREF="zaurus/index.html#Qtopia">ONScripter を Qtopia 環境で動作させるための作業</A>を参照してください。</P>

        </div>

        <div class="diary-day">
          <h3>8月30日</h3>

          <P>以前公開したザウルス用 library パッケージ onscripter-lib_20030816_arm.ipk, onscripter-lib_20030829_arm.ipk ともに、20030704 時点の SDL をパッケージングしていました。さらに、T-nagi さんから御報告のあった A300 での不具合に対する修正も間違っていました。今回の onscripter-lib_20030830_arm.ipk で、T-nagi さんから不具合が修正されたという御報告を頂いているので、今度こそ直っているはずです。</P>

        </div>

        <div class="diary-day">
          <h3>8月29日</h3>

          <P>スプライトの描画の際に、指定されたセル番号が最大セル数内に収まるようにクリップされていなかったバグを修正しました。</P>

          <P>exbtn の音指定(S)に対応しました。</P>

          <P>blt の画像サイズが変わる場合の変換ルーチンのバグを修正しました。セグメンテーションフォルトで落ちる場合がありました。</P>

          <P>getinsert, getzxc を実装しました。</P>

          <P>文字列スプライトで、アンチエイリアスに関する指定に対応しました。ただし解釈のみで反映されません。</P>

          <P>getscreenshot を実装しました。</P>

          <P>gettext で改行を含めないように修正しました。</P>

          <P>ザウルス用ライブラリの onscripter-lib_20030816_arm.ipk で SL-A300 の不具合に対処したつもりでいたのですが、どうやら改善されていなかったようです。というわけで更新しました。ただし未検証です。</P>

        </div>

        <div class="diary-day">
          <h3>8月24日</h3>

          <P>mousePressEvent か keyPressEvent が来たときに、automode 中なら automode を終了するように変更しました。</P>

          <P>ボタン命令に関して、ボタンが重なっている場合に後から定義されたボタンが上下判定で上に来るように修正しました。</P>

          <h4>20030824a</h4>

          <P>ボタン構造体のリンクリストの順序を反転したため、ショートカットキーでのボタン移動順も反転してしまったバグを修正しました。</P>

        </div>

        <div class="diary-day">
          <h3>8月23日</h3>

          <P>αβεさんからのバグ報告を元に、movl で配列変数に正常に値を格納できないバグを修正しました。</P>

          <P>回想モード時に、背景が適切に描画されないバグを修正しました。</P>

          <P>getpage を実装しました。</P>

          <P>mode_ext, automode, automode_time, menu_automode, isskip を実装しました。</P>

          <P>btntime2 を正規に実装しました。</P>

        </div>

        <div class="diary-day">
          <h3>8月19日</h3>

          <P>AVIWrapper があまりにもひどかったので修正しました。だいぶ再生がましになりましたが、たまに Segmentation fault で落ちることがあります（特に MPEG1 の再生）。</P>

          <P>bar の画像生成処理に関するバグを修正しました。</P>

          <P>isfull を実装しました。</P>

          <P>value 宣言に対応しました。value 宣言付きのゲームスクリプトに関して、これより前のバージョンの ONScripter で保存したファイルは、これ以後の ONScripter では正常に読み込めませんのでご注意下さい。その場合は、ONScripter が書き出したファイルを全部消去してください。もっとも、現時点では value 宣言付きのゲームはほとんどないと思います。</P>

          <P>define 節に飛ぶ前にラベルファイルを読み込むように修正しました。</P>

        </div>

        <div class="diary-day">
          <h3>8月16日</h3>

          <P> T-nagi さんより、SL-A300 においてカーソルキーと画面上でのカーソルの動きが反対だという報告をいただきましたので、<A HREF="zaurus/index.html#Package">Zaurus 用の SDL library </A>を<A HREF="zaurus/sl-devel.html#devel-20030816">修正</A>しました。</P>

          <P> 上記のライブラリパッケージを生成するためのスクリプトをよく見たら、なんと古い SDL_mixer, SDL_image, SDL_ttf をパッケージングするようになっていました。というわけで、最新のライブラリを入れるように修正しました。</P>

          <P> <S>Avifile for Linux on ARM をなんとかクロスコンパイルし、<A HREF="http://wind.prohosting.com/ogapee/zaurus/libavifile-0.7_0.7-0.7.38_arm.ipk">libavifile-0.7_0.7-0.7.38_arm.ipk</A> を作成しました。で、ONScripter を試そうと思ったら、AVIWrapper は YUV Overlay を使用するように作ったので、Zaurus 上では表示されませんでした……。YUV Overlay が使えない場合は、普通に描画するようにそのうち修正するかもしれません。結局、上のパッケージは動作確認していないので、そもそも動くのか、どの程度の性能が出るのかは全く不明です。</S>YUV Overlay は、hardware acceleration が対応していない場合でも動作するようです。表示されないのは、ARM 用の Codec が全くないのが原因のようです。というわけで、avifile を使って Zaurus 上で再生するのはあきらめました。他の方法として単純に思いつくのは、MPlayer を子プロセスで起動して再生することですが、これではどうも面白くないのでどうしたものか思案中です。</P>

        </div>

        <div class="diary-day">
          <h3>8月15日</h3>

          <P> スプライトのセル数が１個の場合でも、spbtn, exbtn においてマウスがボタンと重なったときに２個目のセルを前提に処理をしていたバグを修正しました。exbtn において描画がおかしくなる場合がありました。</P>

          <P> 音楽のループ演奏ができなくなっていたバグを修正しました。</P>

          <P> lookbackbutton が効かなくなっていたバグを修正しました。</P>

          <P> <A HREF="http://avifile.sourceforge.net/">avifile</A> library を利用して avi を実装しました。avifile-0.7-0.7.38 で動作確認しております。avifile library が利用できない環境にいる方は、Makefile.Linux を見て、USE_AVIFILE を定義せず、かつ AVIWrapper.o をリンクしないようにしてコンパイルしてください。avifile に関しては、Web を探してもサンプルプログラムが見つからず、SDL から動画が流せるようになるまで手間取りました。単純な wrapper class である AVIWrapper を作り、ONScripter から利用するとともに、これを使った単純な player (simple_aviplay)を同梱しました。SDL 上で非常に簡単に avi を再生できるので、参考にしてください。zaurus でも動くかと思いましたが、そもそも avifile の configure が cross compile 環境だとすんなり通らないので、こちらはとりあえず保留します。Linux with X 上では、画像と音が同期して正常に表示されるものの、avifile 謹製の aviplay と比較して若干カクカクするので、AVIWrapper にはまだ最適化の余地がありそうです。
          </P>

        </div>

        <div class="diary-day">
          <h3>8月11日</h3>

          <P> exec_dll, getret, splitstring を暫定実装しました。dll を実行するわけではなく、用意した dll.txt に記述してある固定値を読み込みセットします。registry.txt と同じ要領です。使用例は <A HREF="onscripter.html#dll">ここ</A>を参照してください。</P>

        </div>

        <div class="diary-day">
          <h3>8月10日</h3>

          <P>ラベルと同じ行に命令もしくはコメントがあった場合に、そのラベルが指す区間の下から一番目と２番目の行が解釈されないバグを修正しました。</P>

          <P>exbtn において、指定スプライトが制御文字列内でも使用されている場合に表示がおかしくなるバグを修正しました。</P>

          <P>maxkaisoupage を実装しました。</P>

          <P>回想用バッファ用に確保した領域外にアクセスしてしまい落ちることがあるバグを修正しました。</P>

          <h4>20030810a</h4>

          <P>Filelog の取り扱いに関して、アーカイブ情報に含める昔の方式と独立に ScirptHandler に持たせる現在の方式とがごっちゃになっており挙動がおかしかったバグを修正しました。</P>

          <P>btnwait の初期状態で既にカーソルがボタン上にあるときに、ボタンが正しく表示されないバグを修正しました。</P>

        </div>

        <div class="diary-day">
          <h3>8月7日<span style="color:red">セーブファイルのバージョンアップ</span></h3>

          <P>セーブファイルのバージョンを上げました。この ONScripter で生成したセーブファイルは以前のバージョンの ONScripter では読み込めません。逆はできます。</P>

          <P>envdata ファイルの読み書きに対応しました。</P>

          <P>標準で global variables を読み書きするファイル名を gloval.sav に変更しました。これが見当たらない場合は、global.sav を探しに行きます。</P>

          <P>s1100089 さんの patch を参考に、-v オプション指定時にバージョンを表示するように修正しました。</P>

          <P>えぼしさんからのバグ報告を元に、jpeg library 用のコールバック関数の戻値を修正しました。</P>

          <P>NScrflog.dat において、アーカイブ内の順序に関係なく、画像のみ現れた順に記録するようにし、また filelog で読み込みを行うように変更しました。</P>

          <P>setwindow で背景に画像が指定された場合に、画像の幅と高さを正しく扱っていなかったバグを修正しました。</P>

          <P>defaultfont を仮実装しました。実際のフォントには反映されません。</P>

          <P>マウスが移動する度に現在のマウス座標を格納する変数を更新するように修正しました。また、btndown でマウス押下が正しく扱われていなかったバグを修正しました。</P>

          <P>非可視状態のスプライトボタンが btnwait 時に表示されないバグを修正しました。</p>

          <P>s1100089 さんからのバグ報告を元に、スクロール効果が正常に表示されないバグを修正しました。</P>

          <P>回想時のマウスホイール操作に対応しました。</P>

          <P>その他内部状態に関する修正が多数あります。</P>

        </div>

        <div class="diary-day">
          <h3>7月4日</h3>

          <P>sarconv, nsaconv で、縮小された画像の四隅のピクセル値が、縮小前の四隅の値を保つように修正しました。透過指定がうまく反映されない場合がありました。</P>

          <P>阿川さんにお送りしたパッチを一部修正の上取り込んでいただいたので、それに基づいて<A HREF="zaurus/sl-devel.html#devel-20030704"> zaurus 版のライブラリパッケージを更新</A>しました。その修正に合わせて、zaurus 版の ONScripter を起動するときに、SDL_DSP_NFRAGMENTS を 18 に設定するように修正しました。</P>

        </div>

      </div> <!-- diary -->
    </div> <!-- diary-container -->


    <div id="footer">
      Copyright (c) 1998-2006 Studio O.G.A. All rights reserved.
    </div> <!-- footer -->

  </div> <!-- body -->

</BODY>

</HTML>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <title>ONScripter 開発日誌</title>
  <link rel="stylesheet" type="text/css" href="/ogapee.css">
</head>

<body>

  <div id="body">

    <div id="header">
      <h1>ONScripter 開発日誌</h1>

      Since: Feb. 6, 2002<br />
      Last updated: Aug. 31, 2022
    </div> <!-- header -->

    <div id="toc-container">

      <h3>過去の開発日誌</h3>

      <div id="toc">
        <ul>
          <li><a href="onscripter_devel.2021.html">2021年</a></li>
          <li><a href="onscripter_devel.2020.html">2020年</a></li>
          <li><a href="onscripter_devel.2019.html">2019年</a></li>
          <li><a href="onscripter_devel.2018.html">2018年</a></li>
          <li><a href="onscripter_devel.2017.html">2017年</a></li>
          <li><a href="onscripter_devel.2016.html">2016年</a></li>
          <li><a href="onscripter_devel.2015.html">2015年</a></li>
          <li><a href="onscripter_devel.2014.html">2014年</a></li>
          <li><a href="onscripter_devel.2013.html">2013年</a></li>
          <li><a href="onscripter_devel.2012.html">2012年</a></li>
          <li><a href="onscripter_devel.2011_1.html">2011年</a></li>
          <li><a href="onscripter_devel.2010_1.html">2010年</a></li>
          <li><a href="onscripter_devel.2009_1.html">2009年</a></li>
          <li><a href="onscripter_devel.2008_1.html">2008年</a></li>
          <li><a href="onscripter_devel.2007_1.html">2007年</a></li>
          <li><a href="onscripter_devel.2006_1.html">2006年</a></li>
          <li><a href="onscripter_devel.2005_1.html">2005年</a></li>
          <li><a href="onscripter_devel.2004_1.html">2004年</a></li>
          <li>2003年
            <ul>
              <li><a href="onscripter_devel.2003_4.html">10月～12月</a></li>
              <li><a href="onscripter_devel.2003_3.html"> 7月～ 9月</a></li>
              <li><a href="onscripter_devel.2003_2.html"> 4月～ 6月</a></li>
              <li><a href="onscripter_devel.2003_1.html"> 1月～ 3月</a></li>
            </ul>
          </li>
          <li>2002年
            <ul>
              <li><a href="onscripter_devel.2002_4.html">10月～12月</a></li>
              <li><a href="onscripter_devel.2002_3.html"> 7月～ 9月</a></li>
              <li><a href="onscripter_devel.2002_2.html"> 4月～ 6月</a></li>
              <li><a href="onscripter_devel.2002_1.html"> 1月～ 3月</a></li>
            </ul>
          </li>
          <li>2001年
            <ul>
              <li><a href="onscripter_devel.2001.html">12月</a></li>
            </ul>
          </li>
        </ul>
      </div> <!-- toc -->
    </div> <!-- toc-container -->


    <div id="diary-container">
      <div id="diary">

        <h2>2022年</h2>

        <div class="diary-day">
          <h3>8月31日</h3>

          <p>App Store ConnectのTestFlightで内部テストを行うことができるように<a href="ios/#SDK">iOS 版 SDK</a>を更新しました。手順については<a href="ios/#application">アプリの申請</a>を参照してください。ゲームデータを内蔵したアプリを作成し、手元のiPad ProにTestFlightアプリ経由でインストールして問題なく動作することを確認しました。そのままApp Store Connectから審査を経て一般に公開することもできると思いますが、未確認です。</p>

        </div>

        <div class="diary-day">
          <h3>8月16日</h3>

          <p>バグ報告「<a href="/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=383">一度終了するとアプリが開かなくなる</a>」を元に、ゲームデータをアプリに同梱すると、アプリをインストールした後に2回目以降は起動に失敗するバグを修正しました。</p>

          <p><a href="android/#distribution">ゲームデータの配布方法</a>を修正し、Play Asset Delivery (PAD) の install-time Asset Pack に対応して、最大1GBまでのゲームデータをアプリに同梱できるようにしました。また、これ以外のゲームデータの配布方法は廃止しました。</p>

          <p>バグ報告「<a href="/cgi-bin/kagemai/guest.cgi?project=onscripter&amp;action=view_report&amp;id=383">一度終了するとアプリが開かなくなる</a>」を元に、bexec命令のバグを修正しました。マニュアルには、引数が1個の文字列変数、もしくは第1引数が文字列変数で第2引数が数値変数の例しか載っていなかったため、bexec命令はこの2パターンにのみ対応していると思っていたのですが、文字列変数と数値変数の任意の組み合わせに対応しているようです。3個以上の引数にも対応しているようですが、実装がたいへんなので、ONScripterでは2個までの引数に対応します。もし3個以上の引数がある既存のゲームが存在する場合は、ご報告いただければ対応を検討します。</p>
        </div>

        <div class="diary-day">
          <h3>7月21日</h3>

          <p><a href="android/#sdk">Android 版 SDK</a> を更新して、Android Gradle Plugin Version を 4.2.2 から 7.0.4 に変更しました。これ以上高くすると、最初に Android Studio を起動したときに以下のようなエラーが出てしまいます。</p>
          <pre>
  Minimum supported Gradle version is ?.?.?. Current version is 7.1.
</pre>

          <p>そして、この状態で File → Project Structure から Gradle Version を設定しようとしてもなぜか反映されません。また、7.0.4 は compileSDK = 31 までしかテストされていないようなので、compileSDK と targetSDK をどちらも 31 にしました。</p>
        </div>

        <div class="diary-day">
          <h3>7月18日</h3>

          <p>Android 11 (API 30)における挙動をエミュレータで試そうとしたところ、以下のエラーが出て arm64 のエミュレータが起動しませんでした。x86_64 のエミュレータは問題なく起動します。</p>
          <pre>
The emulator process for AVD *** has terminated.
</pre>

          <p>C:\Users\username\AppData\Local\Google\AndroidStudio2021.2\log\idea.log には以下のメッセージが出力されていました。</p>
          <pre>
PANIC: Avd's CPU Architecture 'arm64' is not supported by the QEMU2 emulator on x86_64 host.
</pre>

          <p><a href="https://android.googlesource.com/platform/external/qemu/+/1381d44efe69ba0b37fb7f7ef868125e279fc14a/android/emulator/main-emulator.cpp#910">emulator.cpp</a>に以下のように書かれており、API 28以降ではホストが x86_64 の場合 arm64 のエミュレータは起動できないようです。</p>

          <pre>
#ifdef __x86_64__
if (sarch == "arm64" && apiLevel &gt;=28) {
APANIC("Avd's CPU Architecture '%s' is not supported by the QEMU2 emulator on x86_64 host.\n", avdarch);
}
#endif
</pre>
        </div>

        <div class="diary-day">
          <h3>7月6日</h3>

          <p><a href="privacy_policy.html">プライバシーポリシーのページ</a>を作成しました。また、<a href="android/#sdk">Android 版 SDK</a> を更新して、アプリ内のメニューのプライバシーポリシーから Intent を使ってこのページを参照できるようにしました。</p>
        </div>

        <div class="diary-day">
          <h3>7月5日</h3>

          <p>macOS Monterey で動作確認をしました。実機向けは問題なくビルドと実行ができましたが、シミュレータ向けにビルドしようとすると以下のエラーが出たので、dev_iPhoneSimulator.sh の SDK_CFLAGS から -arch i686 を削除し、また HOST を x86_64-apple-darwin に変更したところ、問題なくビルドと実行ができるようになりました。<a href="ios/#SDK">iOS 版 SDK</a>を更新しました。</p>

          <pre>
ld: unknown/unsupported architecture name for: -arch i686
</pre>
        </div>

        <div class="diary-day">
          <h3>1月23日</h3>

          <p><a href="android/#sdk">Android 版 SDK</a> を更新して、<a href="android/#distribution">ゲームデータの配布方法</a>のうち「パターン２：アプリに内蔵する方法」でアプリのアセットにゲームデータを配置した場合に、インストール時にゲームデータを展開せず、実行中はアセットから直接ファイルを読み込むようにしました。AssetManager.openFd は、アセットをまとめた単一ファイルの記述子を返すため、これを指定したファイルの記述子とみなしてネイティブコードに渡すと正常に動作しなくなります。今まではインストール時にアセットのファイルをすべて展開して、実行時にはそれらを読み込んでいたのですが、ディスク領域が2倍必要になるので無駄でした。今回 Android 版では、fseek, ftell, fgetc, fgets, fread, fopen をラップして、アセットファイルにおける指定したファイルの開始位置を考慮して正常に動作するようにしました。この変更のために本体のソースコードも修正しました。</p>

          <p>今回から Google Play では APK ではなく App Bundle 形式でアプリを公開することにしました。</p>
        </div>

        <div class="diary-day">
          <h3>1月18日</h3>

          <p><a href="android/#sdk">Android 版 SDK</a> を更新して、<a href="android/#distribution">ゲームデータの配布方法</a>のうち「パターン２：アプリに内蔵する方法」に対応しました。</p>
        </div>

        <div class="diary-day">
          <h3>1月15日</h3>

          <p>ONScripter::flushDirect において、画面の更新領域の横幅と縦幅の一方が正で他方が0だと Android 版で落ちるバグを修正しました。</p>
        </div>

        <div class="diary-day">
          <h3>1月10日</h3>

          <p>Android 版 20220104 が Android 11 で動作しないとのご報告をいただきました。調べたところ、Android 11 以降では AndroidManifest.xml の android:requestLegacyExternalStorage=&quot;true&quot; が無視されるようになっているようで、アプリ固有の領域以外は File API を使ってアクセスできなくなったようです。</p>

          <p>以前から書き込みは Storage Access Framework の DocumentFile を使うようにしていたのですが、まず、読み込みについても DocumentFile を使うようにしてみました。しかし、DocumentFile.findFile のソースを見ると <a href="https://android.googlesource.com/platform/frameworks/support/+/300475fc42431cefb0d8f1bfc70de1a7a052a501/documentfile/src/main/java/android/support/v4/provider/TreeDocumentFile.java">TreeDocumentFile</a>.listFiles で ContentResolver.query を実行してディレクトリのファイル一覧を取得し、その各ファイルに対して <a href="https://android.googlesource.com/platform/frameworks/support/+/a9ac247af2afd4115c3eb6d16c05bc92737d6305/documentfile/src/main/java/androidx/documentfile/provider/DocumentsContractApi19.java">DocumentsContractApi19</a>.getName でさらに ContentResolver.query を実行しているため非常に遅くなるようです。そこで、ContentResolver.query と DocumentsContract を直接使って効率よくファイルを読み書きするようにして、<a href="android/#sdk">Android 版 SDK</a> と Android 版アプリを更新しました。Android 10 の実機と Android API 32 のエミュレータで動作することを確認しています。ただし、<a href="android/#distribution">ゲームデータの配布</a>に関する箇所は修正しておらず、後日修正する予定です。</p>

          <p>また、本体のソースコードを修正して TTF_OpenFont ではなく TTF_OpenFontRW を使ってフォントファイルを開くようにし、Android 版では Storage Access Framework 経由してフォントファイルを開くようにしました。</p>

          <p>なお、Android Studio からエミュレータを起動しようとすると、vulkan-1.dll が見つからないといったエラーが出て起動しなくなりましたが、以下のファイルを作成したところ起動するようになりました。</p>

          c:\users\username\.android\advancedFeatures.ini
          <pre>
Vulkan = off
GLDirectMem = on
</pre>
        </div>

        <div class="diary-day">
          <h3>1月4日</h3>

          <p>最新の Android Studio と Android SDK の環境で Android 版をビルドできるようにしました。従来の Import module による方法では Google Play Licensing Library を組み込むことができなくなっていましたが、組み込み方を変更して対応し、Android 10 の端末で動作することを確認しました。<a href="android/#sdk">Android 版 SDK</a> と Android 版アプリを更新しました。</p>

        </div>
      </div> <!-- diary -->
    </div> <!-- diary-container -->


    <div id="footer">
      Copyright (c) 1998-2022 Studio O.G.A. All rights reserved.
    </div> <!-- footer -->

  </div> <!-- body -->

</body>

</html>